<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use App\ServiceRequests;
use App\Customers;
use App\StatusTimeline;
use App\Events\RequestStatusUpdated;
use App\NotifyCustomer;


class RequestsUpdate extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'command:requestsupdate';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Bulk update requests by id';

    /**
     * Create a new command instance.
     *
     * @return void
     */
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * Execute the console command.
     *
     * @return mixed
     */
    public function handle()
    {
        $counter = 1;
        $ids = [15317,13274,15337,15320,14076,15181,14666,15222,14903,14303,14721,13835,15058,14410,10979,11845,14168,14318,14816,15188,9332,14763,13676,14166,14815,15258,15215,15101,15090,14953,15039,14498,14764,14997,14561,14310,15026,14921,14433,13473,6003,14083,14193,15229,14854,15045,14994,14945,14571,13734,13913,14685,15206,14861,15321,15169,15053,14898,5719,9942,15034,14938,13688,14874,14334,14393,15359,15175,9755,15355,15299,13241,15140,14456,15191,15093,14409,13565,14518,14278,14794,13787,15000,15333,15096,12165,14983,12065,15151,14071,15008,13301,15021,11726,15227,12952,14870,14703,15141,15361,11727,15205,15297,13721,14933,15014,15374,14463,15287,13280,15346,15349,15336,15331,14856,15335,15282,15228,13479,15323,13872,15308,15309,11027,15080,15079,14922,15298,15286,15289,15293,9688,15210,9996,15267,15262,15235,14982,14968,15245,14723,15237,15234,15231,15220,14767,15221,15194,15154,14081,15077,13471,13477,13475,15197,14014,14791,14905,14008,14520,15163,14836,15170,15160,15131,15067,15117,15143,15017,15108,14737,15139,14955,15103,15111,15116,15095,15126,15123,15046,14002,14228,15072,14975,14884,15048,15041,15027,15009,15031,15013,14832,14889,14985,14455,14993,14600,14962,14937,14969,14971,14920,14775,14773,14784,13842,14943,14881,14487,14918,14741,14924,14469,14587,14908,14894,14875,14857,14264,14470,14827,14818,14757,14696,14842,14747,14746,14374,14552,12807,14822,14287,14023,13674,14407,14817,14771,14778,14800,14788,14745,14796,14539,14720,14792,14500,14783,14740,14758,14642,14686,14744,14695,14358,14743,14284,14734,14224,12323,14731,14728,14694,14704,14702,14701,14700,14681,14058,14692,14635,14680,14590,14652,14548,14632,12860,14628,14627,14629,14607,14596,14609,14553,14599,14564,14591,13918,13959,14035,14544,14580,14532,14554,14567,14566,14531,14507,14493,14513,14516,12810,14502,14457,14282,14283,14501,14420,14509,14489,14496,14478,14411,14482,14476,14397,14445,14426,14438,14051,14001,14401,14419,14402,14396,14099,14184,14365,14368,11886,14371,13113,14265,14332,14353,14349,14341,14340,14333,14325,14306,14299,14262,14263,13203,14279,14274,14286,14290,14269,14277,14258,14260,14217,14256,12094,14230,14203,13177,14244,14229,14223,14165,13114,14198,13193,11689,13017,14124,14129,14136,14117,14112,13349,13793,14029,13996,13424,14106,13413,13855,13767,14101,14098,13921,14103,14089,14027,14077,14080,14067,14034,14052,14028,14031,14005,14006,13998,13962,13947,13978,13849,13923,13817,13718,13934,13784,13707,13900,13910,13874,13875,13864,13857,13852,13836,13808,13780,13783,13774,13753,13751,13755,13157,12553,12308,13531,13344,13499,12834,12817,13745,13736,13729,11652,13722,13724,13679,13682,13639,13645,13635,13562,13620,13260,13612,13613,13014,13570,13600,13594,13558,13544,13557,13541,13545,13532,13359,13550,13461,13469,13524,13512,13358,13503,13319,13435,13470,13420,13464,13224,13446,13406,13429,13419,13433,13408,13194,13414,13403,13385,13351,11766,13071,12651,12112,9774,12054,13331,13330,13146,13222,12612,12271,12861,12628,11913,12960,13261,13249,13204,13234,13229,13217,13106,12622,12959,12900,12922,12790,12603,12708,13063,13225,13218,13190,13184,13216,13185,13175,13189,13166,13153,13176,13141,13165,13169,13164,13064,12186,13149,13046,13124,13086,13097,13096,13107,13105,13111,13088,13089,13095,13093,13087,13058,13076,13061,13050,13034,13036,13037,12772,12884,12326,13012,12996,13007,12978,12993,12994,12976,12895,12187,12446,12539,12926,12919,12441,12924,12282,12034,12406,12354,12098,11856,12585,12764,12913,12912,12898,12905,12876,12891,12859,12867,12866,12853,12851,12832,12847,12349,12762,12789,12801,12800,12794,11795,12172,12066,12760,12614,12301,12256,12757,12732,12725,12754,12739,12729,12559,12716,12213,12699,12653,12695,12692,12677,12609,12639,12643,12641,12640,12588,12582,12607,12615,10652,11157,12580,12549,11873,11226,12550,12558,12555,12545,12517,12516,12193,12530,12488,12427,12513,12519,11823,12023,12489,12502,12493,12415,12447,12492,12452,12486,12483,12477,12467,11819,12474,12466,12465,10895,11523,10787,12336,12414,12416,12417,12418,12419,12379,12422,12385,12407,12400,12399,10833,12225,12384,12393,12391,12149,12376,12368,12332,11794,12177,11626,12322,12358,12347,12341,12338,12309,12327,12328,12313,9289,10902,10429,12291,12307,12304,12255,12296,12272,12279,12278,12277,10642,12249,12246,12245,12244,12088,12238,11155,12174,11673,11217,12176,12185,12164,12057,12145,12111,12120,12129,12140,12108,12136,12127,10600,12119,12093,10810,12100,12103,12084,11963,11900,11959,11428,11931,11932,12039,12019,11281,12030,9914,12020,11970,11879,11824,11966,11981,12002,11996,11977,11994,11976,11982,11882,11806,11815,11978,11437,11972,11971,11961,11946,11868,11938,11937,11917,10984,11865,11924,11867,11908,11915,11898,11903,11896,11890,11883,11880,11847,10846,11231,11105,10713,11591,11551,11368,11828,10746,11841,11400,11118,10322,8107,11721,8215,11820,11792,11796,11807,11797,11813,11812,11804,11407,11699,11665,11331,11765,11770,11743,11753,11749,11742,11717,11734,11708,11722,11725,11704,11703,11677,11696,11692,9761,11684,11681,11676,11672,11654,11653,11633,11625,11634,11619,11296,11029,10800,11607,11045,10748,10781,10927,10417,10473,10256,10894,10587,10425,10266,10036,9210,11565,11491,11598,11562,11454,11577,11583,11582,11546,11568,11566,11503,11556,11557,11541,11553,11532,11242,11519,11386,11515,10270,9836,8646,11490,9305,11462,11479,11267,11457,10524,10847,11439,11429,11435,11434,11427,11433,11424,11395,11411,11410,11398,11392,9373,11379,11221,11346,10336,10413,10341,10194,11244,10459,10453,9165,9578,11319,11316,10634,11299,9374,11295,10566,11286,11292,10647,11277,9994,9961,10519,8818,9690,10837,11125,10908,10854,11127,11135,11276,10993,11224,11149,11210,8336,10711,11239,11197,10613,11227,11200,11201,9328,11173,11148,10730,10714,10707,11020,10541,10001,10829,11065,11163,11179,11180,11176,11177,11169,11001,10898,10731,11167,11143,10595,11151,11120,11042,11038,11132,11126,11085,11087,11110,11088,10625,11104,11086,11062,11102,11040,11044,11036,11057,11056,11023,9188,11047,11015,10768,11030,11028,5201,10963,11012,11011,10975,10961,10117,10960,10952,10953,10932,10931,10943,10942,10893,10937,10901,10900,9612,8803,10920,10513,10921,10919,9254,9557,10430,10870,10885,10911,10865,10878,10877,10867,10660,10789,10869,10864,9185,10857,10841,10836,10799,10108,7979,10677,10835,10830,9438,10448,10085,9610,10217,9326,9939,9626,9507,9503,8496,9646,8136,9948,10464,10208,10312,9529,7250,7443,7442,9603,10821,10488,10815,10395,10796,10786,10773,10290,10762,10761,10690,10449,10261,10775,10772,10591,10521,10324,10315,10632,10763,10630,10584,10644,10727,10726,10623,10729,10664,9401,9638,10645,8737,8857,8822,8807,8842,8825,8844,8871,8796,10342,10226,10680,10673,10373,9756,10244,9722,9623,9721,9726,9862,9870,9735,9737,10612,10656,10618,9995,10070,9800,9301,9298,9299,9063,10352,10343,10095,10144,10110,10149,10131,10130,10086,10083,10028,10051,10049,9997,9951,9892,9893,9867,9888,9792,9773,9485,9817,9783,9555,9655,9629,9553,9112,9054,9429,9408,9460,9293,9396,9221,9276,9121,9008,9045,7157,7966,9286,9389,8168,9760,9563,9513,9363,8943,9330,8555,8917,8669,8400,8297,7400,7508,6812,5264,9525,10231,10170,10094,9519,9785,9707,9659,9684,9680,9637,9482,8244,9466,9447,8325,9080,8994,9148,9150,8513,8933,8520,8148,8049,7782,9992,9632,9631,9551,9044,8673,7964,7962,10589,10596,10579,10563,10401,10575,10567,10559,10558,10538,10532,10528,10499,10480,10444,10432,10422,10416,10412,10394,10361,10351,10330,10299,10387,10363,10273,10251,10367,10281,10316,9962,10321,10332,10333,10271,10294,10274,10258,10207,10206,10166,10196,10179,10174,10159,10142,10150,10141,10132,10116,10118,10097,10084,10054,10053,10042,8576,10003,10024,10025,8937,7674,10010,10008,9881,8958,9856,8661,9181,8246,9845,9841,9969,9751,9912,8744,8782,8368,7636,9974,9889,9641,9835,8328,9006,9929,9234,8451,8594,8208,9581,9876,9599,9533,8624,9919,9136,9808,9903,9898,9861,9240,8512,7513,7544,9550,9812,9786,9784,9135,8567,8164,7193,9831,8639,9778,8964,7930,9296,9076,8616,9725,9685,8705,9671,9584,9585,9451,9077,9329,9093,9082,9203,9033,9083,7392,9064,8429,9617,9674,5241,9633,9640,9622,8997,8452,9419,9570,9569,9412,8605,9496,9520,8366,6638,8299,9467,9268,9477,9250,9087,9092,9422,9426,8866,8947,9407,9318,9200,8928,9336,6055,9285,8530,8002,9227,8750,8022,9207,9214,9187,9147,9154,9086,9124,9119,9131,7272,7277,8157,8233,8258,8394,9048,9026,9051,9052,9013,6060,7896,7720,7391,9032,7390,6582,9011,8438,8960,8948,7864,8407,8210,7598,8602,8598,7518,8791,8792,8793,8763,8508,8312,7769,7239,8751,8259,8690,8687,8696,8622,7135,8593,8626,8453,8552,8621,7106,6964,5512,8516,8321,8485,7566,6765,6149,5855,8389,8391,7237,7289,7270,6830,6768,6294,8320,8281,7963,7816,8163,5552,8162,8156,4975,8112,8048,8047,8042,7000,7155,7013,6842,8026,8006,7978,7965,6857,6594,5860,7833,7848,7404,7583,7808,7799,7762,6521,7763,7141,6895,6653,6648,7748,5851,7618,7444,6589,6021,7459,7406,7367,4630,7317,7290,7297,7292,6954,7032,6022,6702,6520,6277,6673,7166,7120,7156,7151,7015,7072,7059,7046,6972,6997,5852,6937,6933,6793,5663,6801,5783,5612,3550,5042,6659,6606,6605,6535,4891,6319,5087,6311,6153,6341,5953,5816,6320,6207,5401,5160,4276,3852,3539,3187,2743,2462,2324,2245,1939,799,1169,311,5943,5313,5337,4633,5126,5134,4464,4739,4469,3906,3498,4106,3896,3682,3341,3407,3611,3319,1675,2416,1256,6082,5970,6007,5771,5158,3122,5640,5410,5210,4461,4795,4540,4533,4321,4354,4256,4307,4278,4216,4253,3694,5509,3547,5275,5220,5144,5013,4940,4927,4848,4808,4777,4706,4576,4071,4396,4296,4051,4086,3965,3692,3574,3602,3625,3542,3548,3426,3455,3151,2953,2860,2632,2640,2452,2474,2549,2353,2445];
        $requests = ServiceRequests::whereIn('id', $ids)->whereNotIn('status', ['Received','Closed'])->get();

        $bar = $this->output->createProgressBar(count($requests));
        $bar->start();

        foreach ($requests as $servicerequest) {
            echo "$counter: $servicerequest->id - $servicerequest->status <br />";
            $counter++;
            $oldData = $servicerequest;
            $customer = Customers::findOrFail($servicerequest->customer_id);

            $servicerequest->status = 'Closed';
            $servicerequest->save();

            $status = new StatusTimeline;
            $status->status =$servicerequest->status;
            $status->customer_id = $servicerequest->customer_id;
            $status->request_id = $servicerequest->id;
            $status ->save();

            //send_sms('status_update', $customer, $servicerequest, '');
            NotifyCustomer::send_notification('request_update', $servicerequest, $customer);
            event(new RequestStatusUpdated($servicerequest, $customer, $oldData));
            $this->info($servicerequest->id);
            $bar->advance();
        }
        $bar->finish();
    }
}
